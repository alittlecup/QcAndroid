pipeline:
  restore-cache:
    image: drillster/drone-volume-cache
    restore: true
    mount:
      - .gradle
      - gradle_cache
#      - build
    volumes:
      - /tmp/cache:/cache/
  build:
    image: androidci
    workspace:
      base: /root
    secrets: 
      - DEBUG
    when: 
      event: pull_request
    commands:
      - agree-license.sh android-sdk-license 8933bad161af4178b1185d1a37fbf41ea5269c55
      - echo 'start'
      - ./gradlew -g gradle_cache assembleDevDebug --no-daemon
      - fir publish staff/build/outputs/apk/staff-dev-debug.apk -T $DEBUG
      - fir publish trainer/build/outputs/apk/trainer-dev-debug.apk -T $DEBUG
  mirror:
    image: androidci
    workspace:
      base: /root
    secrets: 
      - PRO
    when: 
      branch: develop
    commands:
      - agree-license.sh android-sdk-license 8933bad161af4178b1185d1a37fbf41ea5269c55
      - ./gradlew -g gradle_cache assembleProductRelease --no-daemon
      - fir publish staff/build/outputs/apk/staff-product-release.apk -T $PRO
      - fir publish trainer/build/outputs/apk/trainer-product-release.apk -T $PRO
  rebuild-cache:
    image: drillster/drone-volume-cache
    rebuild: true
    mount:
      - .gradle
      - gradle_cache
#      - build
    volumes:

  before_install:
    - mkdir "$ANDROID_HOME/licenses" || true
    - echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > "$ANDROID_HOME/licenses/android-sdk-license"
    - echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
  licenses:
    - android-sdk-license-.+
    - '.+'
